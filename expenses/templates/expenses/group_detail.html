{% extends 'expenses/base.html' %}
{% load custom_filters %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>{{ group.name }}</h2>
    <a href="{% url 'create_expense' group.id %}" class="btn btn-success">+ Add Expense</a>
</div>

{% if group.description %}
<p class="text-muted">{{ group.description }}</p>
{% endif %}

<div class="row">
    <div class="col-md-8">
        <h4>Recent Expenses</h4>
        {% if expenses %}
            {% for expense in expenses %}
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h5 class="card-title">{{ expense.description }}</h5>
                            <p class="card-text">
                                Paid by: <strong>{{ expense.paid_by.username }}</strong><br>
                                Amount: <strong>${{ expense.amount }}</strong><br>
                                Date: {{ expense.date|date:"M d, Y" }}
                            </p>
                        </div>
                        <div class="text-end">
                            <small class="text-muted">${{ expense.split_equally }} each</small>
                            <div class="mt-2">
                                {% if expense.paid_by == request.user %}
                                <a href="{% url 'edit_expense' expense.id %}" class="btn btn-sm btn-outline-primary">Edit</a>
                                <a href="{% url 'delete_expense' expense.id %}" class="btn btn-sm btn-outline-danger">Delete</a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info">
                No expenses yet. <a href="{% url 'create_expense' group.id %}">Add the first expense!</a>
            </div>
        {% endif %}
    </div>
    
    <div class="col-md-4">
        <!-- Member Management Card -->
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0">Group Members</h5>
                    {% if group|can_manage_members:request.user %}
                    <a href="{% url 'add_member' group.id %}" class="btn btn-sm btn-success">+ Add Member</a>
                    {% endif %}
                </div>
                
                <ul class="list-group list-group-flush">
                    {% for member in group.members.all %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            {{ member.username }}
                            {% if member == group.created_by %}
                            <span class="badge bg-primary">Admin</span>
                            {% endif %}
                            
                            <!-- Show member's balance -->
                            <small class="text-muted d-block">
                                {% with balance=balances|get_item:member %}
                                {% if balance > 0 %}
                                <span class="text-success">+${{ balance|floatformat:2 }}</span>
                                {% elif balance < 0 %}
                                <span class="text-danger">${{ balance|floatformat:2 }}</span>
                                {% else %}
                                <span class="text-muted">$0.00</span>
                                {% endif %}
                                {% endwith %}
                            </small>
                        </div>
                        
                        {% if group|can_manage_members:request.user and member != group.created_by %}
                        <a href="{% url 'remove_member' group.id member.id %}" 
                           class="btn btn-sm btn-outline-danger"
                           onclick="return confirm('Remove {{ member.username }} from group?')">Remove</a>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        
        <!-- Balance Summary Card -->
        <div class="card mt-3">
            <div class="card-body">
                <h5 class="card-title">ðŸ’° Balance Summary</h5>
                
                <div class="row">
                    {% for member, balance in balances.items %}
                    <div class="col-12 mb-2">
                        <div class="d-flex justify-content-between align-items-center p-2 {% if balance > 0 %}bg-success bg-opacity-10{% elif balance < 0 %}bg-danger bg-opacity-10{% else %}bg-light{% endif %}">
                            <span>
                                <strong>{{ member.username }}</strong>
                                {% if member == request.user %}(You){% endif %}
                            </span>
                            <span class="{% if balance > 0 %}text-success{% elif balance < 0 %}text-danger{% endif %}">
                                {% if balance > 0 %}
                                +${{ balance|floatformat:2 }}
                                {% elif balance < 0 %}
                                ${{ balance|floatformat:2 }}
                                {% else %}
                                $0.00
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Settlement Suggestions Card -->
        {% if settlements %}
        <div class="card mt-3">
            <div class="card-body">
                <h5 class="card-title">ðŸ’¡ Settlement Suggestions</h5>
                <p class="text-muted">To settle all debts:</p>
                
                {% for settlement in settlements %}
                <div class="alert alert-info">
                    <strong>{{ settlement.from_user.username }}</strong> should pay 
                    <strong>{{ settlement.to_user.username }}</strong>: 
                    <strong>${{ settlement.amount|floatformat:2 }}</strong>
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <div class="card mt-3">
            <div class="card-body">
                <h5 class="card-title">âœ… All Settled Up!</h5>
                <p class="text-muted">No money owed between members.</p>
            </div>
        </div>
        {% endif %}
        
        <!-- Quick Actions Card -->
        <!-- Replace the Quick Actions Card in group_detail.html -->
        <div class="card mt-3">
            <div class="card-body">
                <h5 class="card-title">Group Management</h5>
                
                <!-- Group Action Buttons -->
                <div class="d-grid gap-2">
                    <a href="{% url 'create_expense' group.id %}" class="btn btn-success">+ Add Expense</a>
                    
                    {% if group.created_by == request.user %}
                        <!-- Group creator options -->
                        <a href="{% url 'add_member' group.id %}" class="btn btn-outline-primary">Manage Members</a>
                        <a href="{% url 'delete_group' group.id %}" class="btn btn-outline-danger">Delete Group</a>
                    {% else %}
                        <!-- Regular member options -->
                        <a href="{% url 'leave_group' group.id %}" class="btn btn-outline-warning">Leave Group</a>
                    {% endif %}
                    
                    <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">Back to Dashboard</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}